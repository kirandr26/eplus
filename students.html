<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ePlus</title>
    <link rel="stylesheet" href="./assets/css/selectric.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/2.3.5/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="./assets/css/main.css">
</head>
<body>
    <div class="page_wrap">
        <div id="toastContainer"></div>
        <div class="eContainer">
            <div class="sideBar">
               
            </div>
            <div class="mainArticle">
                <div class="fTable_header">
                    <div class="fTable_header_top">
                        <div class="fTable_header_title">
                           <div class="sectionWrap">
                                <h3>Students</h3>
                            </div>
                        </div>
                        <div class="fTable_header_profile">

                        </div>
                    </div>
                    <div class="fTable_header_bottom">
                        <div class="fTable_header_search">
                            <div class="inputWrap">
                                <input type="search" id="searchStudent" placeholder="Search Student" required autocomplete="off">
                            </div>
                        </div>
                        <div class="fTable_header_actions">
                            <div class="fTable_header_actions_filter">
                                <select id="standardSelect">
                                    <option value="">Select Standard</option>
                                </select>
                                <!-- hidden initially -->
                                <select id="sectionSelect" style="display:none;">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                            <div class="fTable_header_actions_addNew">
                                <button type="button" class="mBtn iconBtn" id="addStudBtn" data-bs-toggle="modal" data-bs-target="#studentsModalCenter">Add Student 
                                    <span class="material-symbols-outlined">add</span></button>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="studentsTable fTable fhTable">
                    <table id="studentsTable" class="mTable"></table>
                </div>
            </div>
        </div>
       
    </div>

    <!-- Modal -->
     <div class="modal fade" id="studentsModalCenter" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentsModalLongTitle">Add Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modalForm">
                    <form action="" method="post" id="studentForm">
                        <div class="formInner">
                            <div class="formInputWrap">
                                <div class="inputWrap">
                                    <input type="text" id="fName" placeholder="Enter First Name" required autocomplete="off">
                                </div>
                                <div class="inputWrap">
                                    <input type="text" id="lName" placeholder="Enter Last Name" autocomplete="off">
                                </div>
                            </div>
                            <div class="inputWrap">
                                <input type="email" id="stuEmail" placeholder="Enter your email" autocomplete="off">
                            </div>
                            <div class="inputWrap">
                                <input type="text" id="stuCity" placeholder="Enter City" autocomplete="off">
                            </div>
                            <div class="inputWrap btnWrap">
                               <button type="button" class="mBtn mBtn_medium" id="addStudentBtn">Add Student</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        </div>
    </div>

    
    <script>
        (function checkAuth() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const token = localStorage.getItem('token');

            if (isLoggedIn != 'true'  ||  !token) {
                window.location.replace('index.html'); 
            }
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="//cdn.datatables.net/2.3.5/js/dataTables.min.js"></script>
    <script src="./assets/js/sidebar-loader.js"></script>
    <script src="./assets/js/jquery.selectric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/main.js"></script>
    <script>
        /*************************
         * Student Page
         *************************/
        /* ================= GLOBAL ================= */
        // let selectedStandardId = '';
        // let selectedSectionId = '';
        // let studentSearchText = '';
        // const pageLimit = 10;
        let standardsData = [];

        /* ================= DATATABLE ================= */
        const studentTable = new DataTable('#studentsTable', {
            processing: true,
            serverSide: true,
            paging: true,
            pageLength: pageLimit,
            lengthChange: false,
            searching: false,
            ordering: false,

            ajax: function (data, callback) {

                const page = Math.floor(data.start / data.length) + 1;

                let params = new URLSearchParams({
                    page: page,
                    limit: pageLimit
                });

                if (selectedStandardId) params.append('standard_id', selectedStandardId);
                if (selectedSectionId) params.append('section_id', selectedSectionId);
                if (studentSearchText) params.append('search', studentSearchText);

                fetch(`${API_URL}/api/adminServices/students/all?${params.toString()}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                })
                .then(res => res.json())
                .then(res => {

                    const rows = res.data.students.map(s => ({
                        id: s.id,
                        reg_no: s.registration_number,
                        name: s.name,
                        dob: formatDate(s.dob),
                        parent_name: s.parent_name,
                        phone: s.parent_phone ?? '-',
                        grade_section: `${s.standard_name} - ${s.section_name}`
                    }));

                    callback({
                        draw: data.draw,
                        recordsTotal: res.data.pagination.total_records,
                        recordsFiltered: res.data.pagination.total_records,
                        data: rows
                    });
                })
                .catch(() => callback({
                    draw: data.draw,
                    recordsTotal: 0,
                    recordsFiltered: 0,
                    data: []
                }));
            },

            columns: [
                { data: "reg_no", title: "Reg No" },
                { data: "name", title: "Student Name" },
                { data: "dob", title: "DOB" },
                { data: "parent_name", title: "Parent Name" },
                { data: "phone", title: "Phone" },
                { data: "grade_section", title: "Grade / Section" }
            ],

            /* ===== Make entire row clickable ===== */
            rowCallback: function (row, data) {
                $(row)
                    .css('cursor', 'pointer')
                    .off('click')
                .on('click', function () {
                        window.open(`/student-details.html?regid=${data.id}`, '_blank');
                    });
            }
        });

        /* ================= SELECTRIC HELPERS ================= */
        function destroySelectric($el) {
            if ($el.data('selectric')) {
                $el.selectric('destroy');
            }
        }

        /* ================= INIT STANDARD ================= */
        $('#standardSelect').selectric({
            disableOnMobile: false,
            nativeOnMobile: false
        });

        /* ================= LOAD STANDARDS ================= */
        function loadStandards() {
            fetch(`${API_URL}/api/adminServices/standards`, {
                headers: { Authorization: `Bearer ${authToken}` }
            })
            .then(res => res.json())
            .then(res => {

                standardsData = res.data || [];

                let html = `<option value="">Select Standard</option>`;
                standardsData.forEach(s => {
                    html += `<option value="${s.id}">${s.name}</option>`;
                });

                $('#standardSelect').html(html).selectric('refresh');
                resetSection();
            });
        }

        /* ================= RESET SECTION ================= */
        function resetSection() {
            const $sec = $('#sectionSelect');
            destroySelectric($sec);
            $sec.hide().html(`<option value="">Select Section</option>`);
            selectedSectionId = '';
        }

        /* ================= STANDARD CHANGE ================= */
        $('#standardSelect').on('change', function () {

            selectedStandardId = this.value || '';
            resetSection();

            if (!selectedStandardId) {
                studentTable.ajax.reload();
                return;
            }

            const std = standardsData.find(s => s.id == selectedStandardId);
            if (!std || !std.sections) return;

            let html = `<option value="">Select Section</option>`;
            std.sections.forEach(sec => {
                html += `<option value="${sec.id}">${sec.name}</option>`;
            });

            const $sec = $('#sectionSelect');
            $sec.html(html).show();

            if ($sec.find('option').length > 1) {
                $sec.selectric({
                    disableOnMobile: false,
                    nativeOnMobile: false
                });
            }

            studentTable.ajax.reload();
        });

        /* ================= SECTION CHANGE ================= */
        $(document).on('change', '#sectionSelect', function () {
            selectedSectionId = this.value || '';
            studentTable.ajax.reload();
        });

        /* ================= SEARCH (LIVE) ================= */
        let searchTimer = null;
        $('#searchStudent').on('input', function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                studentSearchText  = this.value.trim();
                studentTable.ajax.reload();
            }, 300); // debounce
        });

        /* ================= INIT ================= */
        loadStandards();

        /* ================= ADD STUDENT FORM ================= */
    document.getElementById("addStudentBtn").addEventListener("click", function () {
        const firstName = document.getElementById("fName").value.trim();
        const lastName  = document.getElementById("lName").value.trim();
        const email     = document.getElementById("stuEmail").value.trim();
        const city      = document.getElementById("stuCity").value.trim();
        $(this).addClass('disabled')
        // Combine name (ONLY required field)
        const name = `${firstName} ${lastName}`.trim();

        if (!firstName) {
            showToast('Name is required', 'error');
            return;
        }

        const payload = {
            name: name,
            admission_no: "",
            city: city || "",
            email: email || ""
        };

        fetch(`${API_URL}/api/adminServices/students`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization":  `Bearer ${authToken}` // if required
            },
            body: JSON.stringify(payload)
        })

        .then(res => res.json())
        .then(response => {
            if (response.status) {
                showToast(response.message);
                document.getElementById("studentForm").reset();
                setTimeout(()=>{
                    location.reload();
                },3000)
            } else {
                showToast(response.message, 'error');
            }
        })
        .catch(error => {
            console.error(error);
            showToast("API Error",'error');
        });
    });
    </script>

    
</body>
</html>