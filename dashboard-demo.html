<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EDU+</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
        }

        .dashboard-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .stat-icon.students { background-color: #5B5FC7; }
        .stat-icon.teachers { background-color: #FF7F66; }
        .stat-icon.events { background-color: #FFB800; }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            color: #8B92A7;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #2D3748;
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
        }

        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 400px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .calendar-title {
            color: #2D3748;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .calendar-month {
            color: #2D3748;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: #4D45B5;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .calendar-nav:hover {
            background-color: #f0f2f5;
        }

        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 8px;
        }

        .calendar-table th {
            text-align: center;
            color: #8B92A7;
            font-size: 12px;
            font-weight: 600;
            padding: 8px 0;
        }

        .calendar-table td {
            text-align: center;
            padding: 0;
        }

        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #2D3748;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            margin: 0 auto;
        }

        .calendar-day:hover {
            background-color: #f0f2f5;
        }

        .calendar-day.inactive {
            color: #CBD5E0;
        }

        .calendar-day.today {
            background-color: #FF7F66;
            color: white;
        }

        .calendar-day.today:hover {
            background-color: #ff6b52;
        }

        .calendar-day.holiday {
            background-color: #FFE5E0;
            color: #FF7F66;
            font-weight: 600;
        }

        .calendar-day.holiday:not(.today):hover {
            background-color: #FFD5CE;
        }

        .calendar-day.holiday.today {
            background: linear-gradient(135deg, #FF7F66 0%, #FFB800 100%);
            color: white;
        }

        .calendar-day[data-holiday]::before {
            content: attr(data-holiday);
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #2D3748;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .calendar-day[data-holiday]::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #2D3748;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .calendar-day[data-holiday]:hover::before,
        .calendar-day[data-holiday]:hover::after {
            opacity: 1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #8B92A7;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Include Header -->
    <div id="header-container"></div>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <div id="error-message" class="error" style="display: none;"></div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon students">üë®‚Äçüéì</div>
                <div class="stat-content">
                    <div class="stat-label">Students</div>
                    <div class="stat-value" id="students-count">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon teachers">üë®‚Äçüè´</div>
                <div class="stat-content">
                    <div class="stat-label">Teachers</div>
                    <div class="stat-value" id="teachers-count">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon events">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-label">Events</div>
                    <div class="stat-value" id="events-count">-</div>
                </div>
            </div>

             <div class="stat-card">
                <div class="stat-icon events">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-label">Students absent Today</div>
                    <div class="stat-value" id="spresent-count">-</div>
                </div>
            </div>

             <div class="stat-card">
                <div class="stat-icon events">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-label">Faculty absent Today</div>
                    <div class="stat-value" id="fpresent-count">-</div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-section">
            <div class="calendar-title">School Calendar</div>
            <div class="calendar-header">
                <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
                <div class="calendar-month" id="current-month">December 2025</div>
                <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
            </div>
            
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th>Su</th>
                        <th>Mo</th>
                        <th>Tu</th>
                        <th>We</th>
                        <th>Th</th>
                        <th>Fr</th>
                        <th>Sa</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://13.233.14.66:3003/api/adminServices/adminDashboard';
        let currentDate = new Date();
        let authToken = localStorage.getItem('token');

        // Load header
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(err => console.error('Header load error:', err));

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status && result.data) {
                    const data = result.data;
                    
                    // Update stat cards
                    document.getElementById('students-count').textContent = data.active_students || data.total_students || 0;
                    document.getElementById('teachers-count').textContent = data.active_teachers || data.total_teachers || 0;
                    document.getElementById('events-count').textContent = data.upcoming_holidays_count || 0; 
                    document.getElementById('spresent-count').textContent = data.students_absent_today || 0; 
                                        document.getElementById('fpresent-count').textContent = data.teachers_absent_today || 0; 

                    
                    console.log('Dashboard data loaded:', data);
                } else {
                    showError('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error fetching dashboard:', error);
                showError('Unable to connect to server. Please check your connection.');
            }
        }

        // Fetch holidays for calendar
        async function fetchHolidays(year, month) {
            try {
                const startDate = new Date(year, month, 1).toISOString().split('T')[0];
                const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

                const response = await fetch(
                    `${API_BASE}/dashboard/holidays?start_date=${startDate}&end_date=${endDate}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    console.log('Holidays API response:', result);
                    return result.status ? result.data.holidays : [];
                }
            } catch (error) {
                console.error('Error fetching holidays:', error);
            }
            return [];
        }

        // Render calendar
        async function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            // Get holidays for the month
            const holidays = await fetchHolidays(year, month);
            
            // Create a Map of holiday dates
            const holidayInfo = new Map();
            
            holidays.forEach(h => {
                const startDate = new Date(h.date_start);
                const endDate = new Date(h.date_end);
                
                let current = new Date(startDate);
                while (current <= endDate) {
                    const dateStr = current.toISOString().split('T')[0];
                    holidayInfo.set(dateStr, h.name);
                    current.setDate(current.getDate() + 1);
                }
            });

            console.log('Holiday dates:', Array.from(holidayInfo.keys()));

            // Calculate calendar
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            const tbody = document.getElementById('calendar-body');
            tbody.innerHTML = '';
            
            let html = '';
            let day = 1;
            let nextMonthDay = 1;
            
            // Generate 6 weeks of calendar
            for (let week = 0; week < 6; week++) {
                html += '<tr>';
                
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    const cellIndex = week * 7 + dayOfWeek;
                    
                    if (cellIndex < firstDay) {
                        // Previous month days
                        const prevDay = daysInPrevMonth - firstDay + cellIndex + 1;
                        html += `<td><div class="calendar-day inactive">${prevDay}</div></td>`;
                    } else if (day <= daysInMonth) {
                        // Current month days
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isToday = isCurrentMonth && day === today.getDate();
                        const isHoliday = holidayInfo.has(dateStr);
                        
                        let classes = 'calendar-day';
                        if (isToday) classes += ' today';
                        if (isHoliday) classes += ' holiday';
                        
                        let dataAttr = '';
                        if (isHoliday) {
                            dataAttr = `data-holiday="${holidayInfo.get(dateStr)}"`;
                        }
                        
                        html += `<td><div class="${classes}" ${dataAttr}>${day}</div></td>`;
                        day++;
                    } else {
                        // Next month days
                        html += `<td><div class="calendar-day inactive">${nextMonthDay}</div></td>`;
                        nextMonthDay++;
                    }
                }
                
                html += '</tr>';
                
                // Break if we've shown all days
                if (day > daysInMonth && nextMonthDay > 7) break;
            }
            
            tbody.innerHTML = html;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                console.warn('No auth token found. Please login first.');
            }
            
            fetchDashboardData();
            renderCalendar();
        });
    </script>
</body>
</html>